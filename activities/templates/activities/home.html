{% extends 'activities/base.html' %}
{% load static %}

{% block title %}ãƒ›ãƒ¼ãƒ {% endblock %}
{% block page_title %}ãƒ›ãƒ¼ãƒ {% endblock %}
{% block hamburger_title %}ãƒ›ãƒ¼ãƒ {% endblock %}

{% block content %}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@300;400;500;700&display=swap" rel="stylesheet">
<div class="home">

    <!-- èŠ±ã‚¨ãƒªã‚¢ -->
    <section class="flower-area">
        {% if growth_stage == 0 %}
            <img src="{% static 'activities/images/è‹—-é»„.png' %}" class="flower-img">
        {% elif growth_stage == 1 %}
            <img src="{% static 'activities/images/èŠ½-é»„.png' %}" class="flower-img">
        {% elif growth_stage == 2 %}
            <img src="{% static 'activities/images/è•¾-é»„.png' %}" class="flower-img">
        {% else %}
            <img src="{% static 'activities/images/èŠ±-é»„.png' %}" class="flower-img">
        {% endif %}
    
        <p class="days">
            ãŠèŠ±ã¨éã”ã—ã¦<br>
            <span>{{ total_days }}æ—¥</span>
        </p>
    </section>
    

    <!-- ãŠã™ã™ã‚ã‚¢ã‚¤ãƒ‡ã‚¢ -->
    <section class="recommend">
        <h2>ã‚ãªãŸã¸ã®ãŠã™ã™ã‚ã‚¢ã‚¤ãƒ‡ã‚¢</h2>
    
        <div class="slider">
            <div class="slider-inner" id="cardSlider">
    
                <!-- ã‚«ãƒ¼ãƒ‰â‘ ï¼šãŠã™ã™ã‚ -->
                <div class="slide">
                    <div class="recommend-card">
                        <div class="recommend-header">
                            <div class="icon"></div>
                            <div class="title">å¥åº·ã‚¬ãƒå‹¢</div>
                        </div>
    
                        <p class="description">
                            ï½ï½ï½ï½ï½ï½ï½ï½ï½ï½ï½ï½ï½ï½ï½ï½ï½ï½
                        </p>
    
                        <div class="actions">
                            <form method="post" action="{% url 'stamp_skip' %}" id="skipForm">
                                {% csrf_token %}
                                <button id="skipBtn" class="btn sub">
                                    <!-- {% if not can_stamp %}disabled{% endif %} -->
                                    ä»Šæ—¥ã¯ãƒ‘ã‚¹
                                </button>
                            </form>
                        
                            <form method="post" action="{% url 'stamp_done' %}" id="doneForm">
                                {% csrf_token %}
                                <button  id="doneBtn" class="btn main">
                                    ã§ããŸï¼
                                </button>
                            </form>
                        </div>                       
                    </div>
                </div>
    
                <!-- ã‚«ãƒ¼ãƒ‰â‘¡ï¼šã§ããŸã‚¹ã‚¿ãƒ³ãƒ— -->
                <div class="slide">
                    <div class="stamp-card">
                        <h3>ã§ããŸã‚¹ã‚¿ãƒ³ãƒ—</h3>

                        <div class="stamps">
                            {% for i in "12345" %}
                                <span class="stamp
                                    {% if forloop.counter <= done_days %}
                                        done
                                    {% elif forloop.counter <= total_days %}
                                        skip
                                    {% endif %}
                                "></span>
                            {% endfor %}
                        </div>                                                                                                               
    
                        <!-- <p class="stamp-text">
                            ã‚ã¨ <strong>5æ—¥</strong> ã§ãŠèŠ±ãŒæˆé•·ã™ã‚‹ã‹ã‚‚ï¼ï¼Ÿ
                        </p> -->
                        <p class="stamp-text">
                            {% if next_stage_days == 0 %}
                                ğŸ‰ ãŠèŠ±ãŒæˆé•·ã—ã¾ã—ãŸï¼
                            {% else %}
                                ã‚ã¨ <strong>{{ next_stage_days }}æ—¥</strong> ã§ãŠèŠ±ãŒæˆé•·ã™ã‚‹ã‹ã‚‚ï¼ï¼Ÿ
                            {% endif %}
                        </p>                        
                    </div>
                </div>
    
            </div>
        </div>
    </section>
    
    <!-- ä¸‹éƒ¨ã‚«ãƒ¼ãƒ‰ -->
    <section class="bottom-cards">
        <div class="card">
            <h3>äººæ°—ã®å¥åº·ã‚¢ã‚¤ãƒ‡ã‚¢</h3>
            <p>å¥åº·ã«ãªã‚ã†ã•ã‚“</p>
            <p>ï½ï½ï½ï½ï½ï½ï½ï½ï½ï½</p>
        </div>

         <div class="card">
            <h3>ã‚°ãƒ«ãƒ¼ãƒ—ã®å¥åº·ã‚¢ã‚¤ãƒ‡ã‚¢</h3>
            <p>å¥åº·ã«ãªã‚ã†ã•ã‚“</p>
            <p>ï½ï½ï½ï½ï½ï½ï½ï½ï½ï½</p>
        </div>
    </section>

</div>

<!-- <script>
    document.addEventListener("DOMContentLoaded", () => {
        const slider = document.getElementById("cardSlider");
    
        const doneBtn = document.getElementById("doneBtn");
        const doneForm = document.getElementById("doneForm");
    
        const skipBtn = document.getElementById("skipBtn");
        const skipForm = document.getElementById("skipForm");
    
        let currentIndex = Number(localStorage.getItem("homeSlide")) || 0;
        let currentIndex = 0;
        const maxIndex = 1;
    
        function updateSlide() {
            slider.style.transform = `translateX(-${currentIndex * 100}%)`; -->
            <!-- // localStorage.setItem("homeSlide", currentIndex); -->
        <!-- } -->
    
        <!-- updateSlide();
    
        // function slideAndSubmit(form) {
        //     currentIndex = 1;
        //     updateSlide();
        //     setTimeout(() => form.submit(), 300);
        // }
    
        if (doneBtn && doneForm) {
            doneBtn.addEventListener("click", (e) => {
                e.preventDefault();
                doneBtn.disabled = true;
                skipBtn.disabled = true;
                slideAndSubmit(doneForm);
            });
        }
    
        if (skipBtn && skipForm) {
            skipBtn.addEventListener("click", (e) => {
                e.preventDefault();
                doneBtn.disabled = true;
                skipBtn.disabled = true;
                slideAndSubmit(skipForm);
            });
        }
    
        let startX = 0;
    
        slider.addEventListener("touchstart", (e) => {
            startX = e.touches[0].clientX;
        });
    
        slider.addEventListener("touchend", (e) => {
            const diff = startX - e.changedTouches[0].clientX;
            if (Math.abs(diff) < 50) return;
    
            if (diff > 0 && currentIndex < maxIndex) currentIndex++;
            if (diff < 0 && currentIndex > 0) currentIndex--;
    
            updateSlide();
        });
    });
    </script>     -->

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const slider = document.getElementById("cardSlider");
            const doneBtn = document.getElementById("doneBtn");
            const skipBtn = document.getElementById("skipBtn");
        
            let currentIndex = 0;
            const maxIndex = 1;
        
            function updateSlide() {
                slider.style.transform = `translateX(-${currentIndex * 100}%)`;
            }
        
            function getCSRFToken() {
                return document.querySelector('[name=csrfmiddlewaretoken]').value;
            }
        
            function submitStamp(url) {
                doneBtn.disabled = true;
                skipBtn.disabled = true;
        
                // ã‚«ãƒ¼ãƒ‰â‘¡ã¸
                currentIndex = 1;
                updateSlide();
        
                fetch(url, {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": getCSRFToken(),
                        "X-Requested-With": "XMLHttpRequest",
                    },
                })
                .then(res => res.json())
                //.then(data => {
                  //  if (data.error) return;
        
                    // 1æšç›®ã®æ•°å­—ã‚’å³æ›´æ–°
                   // document.querySelector(".days span").textContent =
                     //   data.total_days + "æ—¥";
                //});
                .then(data => {
                    if (data.error) return;
                    // æ—¥æ•°æ›´æ–°
                    document.querySelector(".days span").textContent =
                    data.total_days + "æ—¥";
                    // æˆé•·ã—ãŸã¨ãã ã‘ç”»åƒæ›´æ–°
                    if (data.growth_stage !== undefined) {
                        const img = document.querySelector(".flower-img");
                        img.src = data.image_url;
                        localStorage.setItem("flowerImage", data.image_url);
                    }
                });

            }
        
            doneBtn.addEventListener("click", (e) => {
                e.preventDefault();
                submitStamp("{% url 'stamp_done' %}");
            });
        
            skipBtn.addEventListener("click", (e) => {
                e.preventDefault();
                submitStamp("{% url 'stamp_skip' %}");
            });
        
            // ã‚¹ãƒ¯ã‚¤ãƒ—
            let startX = 0;
            slider.addEventListener("touchstart", (e) => {
                startX = e.touches[0].clientX;
            });
        
            slider.addEventListener("touchend", (e) => {
                const diff = startX - e.changedTouches[0].clientX;
                if (Math.abs(diff) < 50) return;
                if (diff > 0 && currentIndex < maxIndex) currentIndex++;
                if (diff < 0 && currentIndex > 0) currentIndex--;
                updateSlide();
            });
        });
        </script>
        
{% endblock %}